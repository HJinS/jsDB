### 기본
---
- 보통 노드 하나는 딤스크 페이지 하나에 저장된다.
- 노드 크기는 삽입/삭제에 의해 변하기 때문에 Slotted Page 구조를 사용한다.

### Slotted Page
---
Page Header
- 페이지의 메타데이터 저장

Slot Array
- 각 레코드의 위치(offset)와 같이 정보를 저장하는 작은 배열

Data Area
- 페이지의 뒤 -> 앞 으로 자라며, 실제 **키, 값** 데이터가 저장

Free Space
- Slot Array 와 Data Area 사이의 남는 공간

#### 동작 방식
**삽입**
- 새로운 데이터를 빈 공간(Data Area)에 추가하고, 슬롯 배열(Slot Array)에 그 데이터의 위치와 같이 길이를 기록

**삭제**
- 슬롯 배열(Slot Area)에서 해당 레코드를 가리키는 슬롯 정보만 삭제하거나 "삭제됨"으로  표시
- 실제 데이터는 나중에 **페이지 압축** 할 때 정리

### 페이지 관리
---
모든 노드 참조는 고유한 **페이지 ID**(보통 8 Bit)를 사용
- InternalNode 자식 포인터 -> 자식 노드의 페이지 ID 목록
- LeafNode의 형제 포인터 -> 형제 리프 노드의 페이지 ID

#### 파일 헤더, 루트 포인터
B+Tree 를 저장하는 파일의 맨 앞부분(첫번째 페이지)은 특별한 **파일 헤더** 페이지를 사용. 

### 버퍼풀 매니저
---
버퍼풀에 페이지 캐시 영역을 두고 사용
1. 페이지 요청: 특정 pageId의 페이지 요청
2. 캐시 확인: 해당 페이지가 이미 버퍼풀에 있는지 확인 있으면 반환.
3. 캐시 미스
   - 디스크에서 읽어와야함
   - 버퍼풀이 가득 차면 교체 전략(Replacement Policy, 주로 LRU(Least Recently Used))에 따라 가장 오랫동안 사용되지 않은 페이지를 교체
   - 선택된 페이지가 더티 페이지라면(수정 되었다면) 디스크에 먼저 flush(저장) 한 후 공간을 비움
   - 비워진 공간에 요청받은 페이지를 읽은 후 메모리 주소 반환



TODO
- Slotted Page 조사
- mmap(메모리 맵 파일)
- FileChannel



### 해야할 것

#### 페이지 기반 파일 I/O
- 고정 크기 페이지: 모든 디스크 I/O는 4KB 혹은 8KB 등의 고정 크기 페이지 단위로만 이루어져야 한다.
- 특정 페이지 번호를 파일 오프셋으로 변환하여 파일의 특정 위치를 직접 읽고 쓸 수 있어야 한다.
- 메모리의 변경사항을 디스크 파일에 안전하게 반영하는 기능이 필요

#### 버퍼 풀 메니저
- 페이지 캐싱: 디스크에서 읽은 페이지를 메모리 안에 버퍼플에 저장하고 관리
- 페이지 요청 처리: 특정 페이지 요청 시 버퍼 풀에 해당 페이지가 있는지(Cache Hit) 확인하고 없으면 디스크에서 읽어와 버퍼풀에 적재해야 한다.
- 교체 정책: 버퍼풀이 가득 찼을 때 어떤 페이지를 디스크로 내보낼지 결정하는 정책 필요(LRU 일반적)
- 더티 페이지 추적: 메모리에서 내용이 변경된 페이지를 추적해야 한다. 이런 페이지는 버퍼풀에서 제거되기 전에 반드시 디스크에 저장되어야 한다.
- 페이지 고정: 특정 스레드가 페이지를 사용하는동안 다른 스레드가 해당 페이지를 버퍼풀에서 내보내지 못하도록 고정하는 기능이 필요하다.

#### 페이지 할당 및 공간 관리
- 새 페이지 할당: B+Tree 노드가 분할될 떄, 새로운 페이지를할당해야 한다. 파일 끝에 공간을 추가하거나, 이전에 사용했다가 삭제된 페이지를 재사용 해야한다.
- 프리 리스트: 삭제되어 비어있는 페이지들의 목록을 관리하여 재사용 할 수 있도록 해야한다. 이를 통해 디스크 단편화를 줄이고 파일이 불필요하게 커지는 것을 막는다.

#### 동시성 제어
- 페이지 래치: 버퍼 풀의 특정 페이지에 여러 스레드가 동시에 접근하여 내부 구조를 망가뜨리는 것을 막기 위해 매우 짧은 시간동안의 메모리 잠금(Latch)이 필요하다.
- 이는 트랜잭션 락 보다 훨씬 가볍고 빠르다.


### DistManager

> 데이터베이스 파일로 부터 page 를 가져오고 저장하는 역할
> readPage, writePage, allocatePage, getNumPages, close 등

### BufferPoolManager

> Page 를 가져올 때 캐싱하는 역할도 같이 함. DiskManager 를 사용해서 Page 를 가져오며, Disk I/O 를 최소화하는 것이 목표
> fetchPage, newPage, unpinPage, flushPage, flushPages 등.
> bufferPool, pageTable, replacer, freeFrames 등 필요

### Page

> 별도의 클래스 보다는 Page 클래스 혹은 Node 클래스에 통합시키는 것이 맞음.
> SlottedPage 관리